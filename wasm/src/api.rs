use crate::frontend_validation::FrontendValidation;
use crate::neuralnetwork::{create, neural_network_from_string, neural_network_to_string, train};
use crate::{
    base64_png::Base64Png, mnist_image::MnistImage, neuralnetwork_image::NeuralNetworkImage,
};
use anyhow::{bail, Context};
use core::neuralnetwork::query::{QueryData, QueryEntry};
use std::convert::TryFrom;
use wasm_bindgen::{prelude::wasm_bindgen, JsValue};

#[wasm_bindgen]
pub fn get_random_image() -> Result<String, JsValue> {
    match Base64Png::try_from(MnistImage::get_random()) {
        Ok(ok) => Ok(ok.0),
        Err(err) => Err(JsValue::from(format!(
            "Rust error in get_3_random_images: {:?}",
            err
        ))),
    }
}

#[wasm_bindgen]
pub fn query_neuralnetwork(
    neuralnetwork_as_string: Option<String>,
    image: Option<String>,
) -> Result<Vec<String>, JsValue> {
    match query_nn(neuralnetwork_as_string, image) {
        Ok(ok) => Ok(ok),
        Err(err) => Err(JsValue::from(format!(
            "Rust error in feed_to_neuralnetwork: {:?}",
            err
        ))),
    }
}

fn query_nn(
    neuralnetwork_as_string: Option<String>,
    image: Option<String>,
) -> anyhow::Result<Vec<String>> {
    let image = image.context("query_nn: image is empty")?;
    let neuralnetwork_as_string =
        neuralnetwork_as_string.context("query_nn: neuralnetwork_as_string is empty")?;
    let neural_network = neural_network_from_string(neuralnetwork_as_string)
        .context("query_nn: problem in neural_network_from_string")?;
    let neural_network_image = NeuralNetworkImage::try_from(Base64Png(image))
        .context("query_nn: cannot convert Base64Png to NeuralNetworkImage")?;
    let result = neural_network
        .query(&QueryData(&vec![QueryEntry {
            input: neural_network_image.0,
        }]))
        .context("query_nn: error while querying")?;
    Ok(result
        .0
        .iter()
        .flat_map(|queryresult| queryresult.0.iter().map(|result| result.to_string()))
        .collect::<Vec<String>>())
}

#[wasm_bindgen]
pub fn train_neuralnetwork(
    amount_of_hidden_neurons: Option<i32>,
    amount_of_training_rounds: Option<i32>,
    learning_rate: Option<f64>,
) -> Result<String, JsValue> {
    match train_nn(
        amount_of_hidden_neurons,
        amount_of_training_rounds,
        learning_rate,
    ) {
        Ok(ok) => Ok(ok),
        Err(err) => Err(JsValue::from(format!(
            "Rust error in train_neuralnetwork: {:?}",
            err
        ))),
    }
}

fn train_nn(
    amount_of_hidden_neurons: Option<i32>,
    amount_of_training_rounds: Option<i32>,
    learning_rate: Option<f64>,
) -> anyhow::Result<String> {
    match (
        amount_of_hidden_neurons.frontend_validation(10, 100),
        amount_of_training_rounds.frontend_validation(1, 10),
        learning_rate.frontend_validation(0.1, 1.0),
    ) {
        (Err(err), _, _) => bail!(format!(
            "train_nn: amount of hidden neurons is incorrect. {}",
            err
        )),
        (_, Err(err), _) => bail!(format!(
            "train_nn: amount of training rounds is incorrect. {}",
            err
        )),
        (_, _, Err(err)) => bail!(format!(
            "train_nn: value for learning rate is incorrect. {}",
            err
        )),
        (Ok(amount_of_hidden_neurons), Ok(amount_of_training_rounds), Ok(learning_rate)) => {
            let neural_network = create(amount_of_hidden_neurons);
            let trained_neural_network =
                train(neural_network, amount_of_training_rounds, learning_rate)
                    .context("train_nn: error while training")?;
            Ok(neural_network_to_string(&trained_neural_network)
                .context("train_nn: error while converting to string")?)
        }
    }
}

#[cfg(test)]
mod tests {
    use crate::{
        base64_png::Base64Png, mnist_image::MnistImage, neuralnetwork_image::NeuralNetworkImage,
    };
    use std::convert::TryFrom;

    #[test]
    fn from_random_mnistimage_to_base64_to_nnimage_back_to_mnistimage() {
        let random_image = MnistImage::get_random();
        let base64png = Base64Png::try_from(random_image.clone()).unwrap();
        let nn_image = NeuralNetworkImage::try_from(base64png).unwrap();
        assert_eq!(MnistImage::from(nn_image).0, random_image.0);
    }

    #[test]
    fn test_neuralnetwork_image_try_from() {
        let base64png = Base64Png(String::from(
            r#"<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAcCAAAAABXZoBIAAAB5UlEQVR4Ae3gAZAkSZIkSRKLqpm7R0REZmZmVlVVVVV3d3d3d/fMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMzMdHd3d3dXV1VVVVVmZkZGRIS7m5kKz0xmV3d1d3dPz8zMzMxMYuX5A6Dy/AFQef4AqDx/AFSePwACAHTqL53OzPzWz71OAAACgJN3dTzLt3zSPgCIK173k2/5JoCHv3O/xbd/zBEA4rk9/NPek/f8AQCC5/aU34KXBYDKc9t+O7gIAOK5PPzL34ILD78EQOV+88cCvM+7HYO3vwQAlWd62Ed9GM/0V38JAIhn+rb35Vle9U8AoPJMj7/7ei79GXz7W7314iceuweAuN/DTnPwDwCf8vmcuQBABYCXfNhfPfWpXHEnAAABAO/z4z//YK54k4/jKQMABAD8HY/5wy+6BeCWb31xvvIAAAIAfvTxXPsBp4CP+7MbeOIPAwDiikc8gX94SW74yZfu+JRvuQQAiCviu9+t7VG34VO+ogEAFK5weey1i8WMz36r30kAAMT9rvnsD7rzu57+vcllAIjnD4DK8wdA5fkD4B8B7WdOvfKkaCsAAAAASUVORK5CYII=">"#,
        ));
        assert_eq!(
            NeuralNetworkImage::try_from(base64png).unwrap().0,
            vec![
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01388235294117647,
                0.08376470588235294,
                0.8097647058823529,
                1.0,
                0.9961176470588236,
                1.0,
                0.9961176470588236,
                0.9961176470588236,
                0.9961176470588236,
                0.9961176470588236,
                0.6078823529411764,
                0.5147058823529411,
                0.10317647058823529,
                0.01388235294117647,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.07988235294117646,
                0.9728235294117646,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.5923529411764706,
                0.060470588235294116,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.26623529411764707,
                0.7321176470588235,
                0.8485882352941176,
                0.4409411764705882,
                0.4409411764705882,
                0.4409411764705882,
                0.4409411764705882,
                0.4409411764705882,
                0.5807058823529412,
                0.9223529411764705,
                0.9456470588235294,
                0.9922352941176471,
                0.9922352941176471,
                0.604,
                0.04882352941176471,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.14976470588235294,
                0.6272941176470588,
                0.9922352941176471,
                0.9922352941176471,
                0.3632941176470588,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.3749411764705883,
                0.9922352941176471,
                0.9922352941176471,
                0.5574117647058824,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.060470588235294116,
                0.6971764705882353,
                0.9922352941176471,
                0.9922352941176471,
                0.4914117647058823,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.14976470588235294,
                0.6932941176470588,
                0.9922352941176471,
                0.9922352941176471,
                0.9223529411764705,
                0.06823529411764706,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.041058823529411766,
                0.20411764705882354,
                0.20411764705882354,
                0.20411764705882354,
                0.20411764705882354,
                0.20411764705882354,
                0.5807058823529412,
                0.934,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.25458823529411767,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.1458823529411765,
                0.5768235294117646,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.802,
                0.060470588235294116,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.6117647058823529,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.2235294117647059,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.4525882352941177,
                0.8951764705882354,
                0.9922352941176471,
                0.9922352941176471,
                0.934,
                0.7282352941176471,
                0.7282352941176471,
                0.7282352941176471,
                0.33999999999999997,
                0.6467058823529412,
                0.9572941176470589,
                0.9922352941176471,
                0.8951764705882354,
                0.06435294117647058,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.1458823529411765,
                0.2235294117647059,
                0.2235294117647059,
                0.17694117647058824,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.4797647058823529,
                0.9922352941176471,
                0.9922352941176471,
                0.07988235294117646,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.18858823529411764,
                0.3244705882352941,
                0.13423529411764706,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.3749411764705883,
                0.9922352941176471,
                0.9922352941176471,
                0.07988235294117646,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.5651764705882353,
                0.9922352941176471,
                0.8330588235294119,
                0.13423529411764706,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.2934117647058823,
                0.8214117647058823,
                0.9922352941176471,
                0.8524705882352941,
                0.05658823529411765,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.3904705882352941,
                0.9922352941176471,
                0.9922352941176471,
                0.9029411764705882,
                0.5341176470588236,
                0.1264705882352941,
                0.01,
                0.01,
                0.01,
                0.01,
                0.1264705882352941,
                0.8912941176470588,
                0.9922352941176471,
                0.9922352941176471,
                0.4098823529411765,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.05658823529411765,
                0.8330588235294119,
                0.9922352941176471,
                0.9922352941176471,
                0.9262352941176472,
                0.20023529411764707,
                0.01,
                0.01,
                0.01,
                0.45647058823529413,
                0.9145882352941176,
                0.9922352941176471,
                0.9922352941176471,
                0.8408235294117647,
                0.06823529411764706,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.15364705882352944,
                0.9922352941176471,
                0.9922352941176471,
                0.8252941176470587,
                0.01,
                0.01,
                0.11094117647058822,
                0.7864705882352941,
                0.9728235294117646,
                0.9922352941176471,
                0.9922352941176471,
                0.4681176470588236,
                0.06823529411764706,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01776470588235294,
                0.6389411764705882,
                0.9922352941176471,
                0.9805882352941176,
                0.9262352941176472,
                0.9262352941176472,
                0.941764705882353,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.4681176470588236,
                0.02164705882352941,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.3361176470588235,
                0.8252941176470587,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.9922352941176471,
                0.49529411764705883,
                0.05658823529411765,
                0.01776470588235294,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.09541176470588235,
                0.5923529411764706,
                0.9922352941176471,
                0.8874117647058823,
                0.5108235294117647,
                0.3827058823529412,
                0.01776470588235294,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01,
                0.01
            ]
        );
    }
}
